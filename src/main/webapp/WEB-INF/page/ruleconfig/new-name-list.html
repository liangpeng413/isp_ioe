<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>用户策略规则-新增名单</title>
 <link href="${staticRoot}/css/bootstrap.min.css" rel="stylesheet">
    <link href="${staticRoot}/font-awesome/css/font-awesome.css" rel="stylesheet">

    <!-- FooTable -->
    <link href="${staticRoot}/css/plugins/footable/footable.core.css" rel="stylesheet">

    <link href="${staticRoot}/css/animate.css" rel="stylesheet">
    <link href="${staticRoot}/css/style.css?rand=${random}" rel="stylesheet">
    <link href="${staticRoot}/css/styleT.css?rand=${random}" rel="stylesheet">
    <link href="${staticRoot}/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="${staticRoot}/css/oms/ruleconfig/ruleconfig.css" rel="stylesheet">
   <link href="${staticRoot}/css/oms/ruleconfig/myStyle.css" rel="stylesheet">
   <link href="${staticRoot}/css/oms/ruleconfig/look-page.css" rel="stylesheet">
   <!--基本样式-->
	<link href="${staticRoot}/css/oms/ruleconfig/select-mania.css" rel="stylesheet" type="text/css">

	<!--自定义样式-->
	<link href="${staticRoot}/css/oms/ruleconfig/select-mania-theme-darkblue.css" rel="stylesheet" type="text/css">
	<link href=".${staticRoot}/css/oms/ruleconfig/select-mania-theme-green.css" rel="stylesheet" type="text/css">
	<link href="${staticRoot}/css/oms/ruleconfig/select-mania-theme-orange.css" rel="stylesheet" type="text/css">
	<link href="${staticRoot}/css/oms/ruleconfig/select-mania-theme-red.css" rel="stylesheet" type="text/css">
	<link href="${staticRoot}/css/oms/ruleconfig/select-mania-theme-square.css" rel="stylesheet" type="text/css">
	<link href="${staticRoot}/css/oms/ruleconfig/look-page1.css" rel="stylesheet">
	<style>
    .circleLetter {
      display: block;
      width: 30px;
      height: 30px;
      background: #8aa0e7;
      text-align: center;
      line-height: 30px;
      color: white;
      font-size: 14px;
      border-radius: 100%;
    }
    .beautifyInput {
      width: 300px;
      height: 30px;
      border-width: 1px;
      border-style: solid;
      border-color: #b6b6b6;
      border-image: initial;
      border-radius: 5px;
    }
    .beautifyBtn {
      width: 160px;
      height: 46px;
      color: white;
      border-radius: 5px;
      background: #8aa0e7;
      text-align: center;
      font-size: 16px;
      margin-top: 10px;
    }
    .bg {
      height: 30px;
      line-height: 30px;
      background: #f4f5f6;
    }
    .selectChecked {
    	display: flex;
    	div {
    	 display: flex;
    	 just
    	}
    }
    .beautifyBtnBack {
      width: 75px;
      height: 40px;
      line-height: 40px;
      color: white;
      border-radius: 5px;
      color: #8aa0e7;
      text-align: center;
      font-size: 16px;
      border: 1px solid #8aa0e7;
      margin-top: 10px;
      margin-left: 18px;
    }
    .checkSelect-wrap {
      display: flex;
    }
    .checkSelect {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100px;
      margin-right: 40px;
    }
    .checkSelect input {
      margin: 0;
      margin-right: 10px;
    }
        .andOrBtn {
            width: 75px;
            height: 30px;
        }
    </style>
	
     <script>
        var globalConfig = {
            basePath: "${ctx}",
            staticRoot: "${staticRoot}",
            loginName: "${Session.sessionUser.loginName}",
            userName: "${Session.sessionUser.name}",
            rosterId: "${rosterId}",
            channel:"${channel}",
            dataType:"${dataType}"
        };
        function swalMsg(msg) {
            swal({
                title: "",
                text: msg,
                confirmButtonColor: "#1ab394",
                confirmButtonText: "确定"
            });
        }

    </script>
</head>
<body>
<div id="wrapper">
    <div class="header-box">
        <#include "/common/top.html" encoding="UTF-8" />
    </div>
    <nav class="navbar-default navbar-static-side nav-boxa" role="navigation" id="HeadTitle">
        <div class="sidebar-collapse"  style="height: 675px;overflow-y: scroll;">
            <#include "/common/left.html" encoding="UTF-8" />
        </div>
    </nav>
</div>
<div class="content-box">
  <div class="look-pagea">
    <!-- <button id="returnBack"><i class="fa fa-chevron-left"></i><a href="#">返回</a></button> -->
    <div id="returnBack" class='beautifyBtnBack'><a href="#">返回</a></div>
  </div>
  <div class="look-pageb">
    <p>*分组名称:</p>
    <input type="text" class="groupingNmae" name="rosterName" id="rosterName" placeholder='不超过50个字' maxlength="50">
    <p>*理财渠道:</p>
	  
	<!-- <select class="conduct-select" name="channelCode" id="channelCode">
      <option value="WK">悟空理财</option>
      <option value="QB">玖富钱包</option>
    </select> -->
    <div class="checkSelect-wrap">
		      <div class="checkSelect">
		        <input id="wkChannel" type="radio" value="WK" checked="checked" name="channelCode">
		        <span>悟空理财</span> 
		      </div>
		      <div class="checkSelect">
		        <input id="qbChannel" type="radio" value="QB" name="channelCode">
		        <span>玖富钱包</span>
		      </div>
	</div>

    <p>*名单类型:</p>
    <select class="name-select" name="rosterType" id="rosterType">
      <option value="悟空理财">悟空理财</option>
      <option value="玖富钱包">玖富钱包</option>
    </select>
    <p>*查询条件: <b><span id='showConditon'></span></b></p>
    <!-- 动态效果 -->
    <div class="query-wrap">
    </div>
    <div class="add-query-info-button"><img class="fa fa-align-justify andOrBtn" src="${staticRoot}/img/andBtn.png"><br></div>
    <div><button class="beautifyBtn" style="margin-right:20px" id="findUserNum">查询</button>符合条件用户数量：<span id="userNum">0</span></div>
    <p class="reset-preservation"><button class="reset beautifyBtn">重置</button><button class="beautifyBtn" id="saveData">保存</button></p>
  </div>
 <!--  <div class="look-pagea" style="margin-top:8px;">
    <button class="JianBian"><i class="fa fa-chevron-left"></i><span>保存</span></button>
  </div> -->
</div>
<!-- Mainly scripts -->
<script src="${staticRoot}/js/jquery-2.1.1.js"></script>
<script src="${jsRoot}/plugins/laydate/laydate.js"></script>
<script src="${staticRoot}/js/bootstrap.min.js"></script>
<script src="${staticRoot}/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="${staticRoot}/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="${staticRoot}/js/plugins/jeditable/jquery.jeditable.js"></script>

<!-- Data Tables -->
<script src="${staticRoot}/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="${staticRoot}/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="${staticRoot}/js/plugins/dataTables/dataTables.responsive.js"></script>
<script src="${staticRoot}/js/plugins/dataTables/dataTables.tableTools.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="${staticRoot}/js/inspinia.js"></script>
<script src="${staticRoot}/js/plugins/pace/pace.min.js"></script>
<!-- 插件select -->

<script type="text/javascript" src="${staticRoot}/js/select-mania.js"></script>
<script >
//根据渠道查询的条件信息初始化列表
var initSelectDataList="";
//查询条件名称初始化列表
var initQueryNameList="";
//查询条件符号初始化列表
var initQueryCriteriaList="";
//查询条件值的输入框初始化类型
var initQueryValue="";
//查询条件符号动态列表
var QueryCriteriaList="";
//and组HTML元素
var strBigGroup;
//or组html元素
var strSmallGroupInit;
//or组多选框html元素（预留，暂时未使用）
var strMultiGroup;

//三期--查询条件返回值集合
var selectCreateGroupList="";
var getRulesList = "";
//三期--渠道
var channel="";

function rosterTypeSelectCreate(){//名单类型列表生成
	$.post(globalConfig.basePath + "/operation/init/byKey","type=14",function(data){
    	var strRosterType="";
    	if(data.code!='000'){
        	alert(data.message);
        	return;
        }
   		for (var i = 0; i < data.resp.length; i++) {
   			strRosterType+="<option value='"+data.resp[i].key+"'>"+data.resp[i].value+"</option>"
			}
    	$("#rosterType").html(strRosterType)
    },"json")
}
//url跳转获取参数方法
function GetRequest() {
    //获取url中"?"后的字符串
    var url = location.search;
    var theRequest = new Object();
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for (var i = 0; i < strs.length; i++) {
            theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
        }
    }
    return theRequest;
}

//判断字符是否为空的方法
function isEmpty(obj){
    if(typeof obj == "undefined" || obj == null || obj == ""){
        return true;
    }else{
        return false;
    }
}

//三期--查询条件返回值集合方法
function  selectConditionList() {
    var objectJson=GetRequest();
    var jsonArray={};
    var feature=objectJson["feature"];
    channel=objectJson["channel"];
    var featureType=objectJson["featureType"];
    jsonArray={"feature":feature,"channel":channel,"featureType":featureType}
    var JsonData = JSON.stringify(jsonArray);
    if(!isEmpty(feature) && !isEmpty(channel) && !isEmpty(featureType)){
        $.ajax({
            type: "post",
            url: globalConfig.basePath + "/ruleConfigAddDetail/queryCreateGroupUserCondition",
            data: JsonData,
            contentType:'application/json',
            async: false,
            dataType: "json",
            success: function (data) {
                if(data.code=='000'){
                    if(data.resp.data==null){
                        selectCreateGroupList="";
                    }else{
                        selectCreateGroupList=data.resp.data;
                    }
                }else{
                    alert(data.message)
                }
            }
        });
    };
}

function  getRuleList() {

    if(globalConfig.rosterId!='NO_RULES'){
        $.ajax({
            type: "get",
            url: globalConfig.basePath + "/ruleConfigAddDetail/queryMemberRosterRules?MemberId="+globalConfig.rosterId,
            data: rosterId,
            contentType:'text/html',
            async: false,
            dataType: "json",
            success: function (data) {
                console.log(data,"获取名单下拉选项");
                relationDownOption = data.data.option;
            }
        });
    };
}

function queryRelationDown(relationId){
    $.ajax({
        type: "get",
        url: globalConfig.basePath + "/ruleConfigAddDetail/getrelationDown?relationId="+relationId,
        data: globalConfig.rosterId,
        contentType:'text/html',
        async: false,
        dataType: "json",
        success: function (data) {
            console.log(data,"返回的规则集合");
            relationDownData = data.resp.data;
        }
    })
}
function initdata(){
	 $.ajax({
         type: "post",
         url: globalConfig.basePath + "/ruleConfigAddDetail/queryList",
         data: "channelCode="+$("[name=channelCode]:checked").val()+"&dataType="+globalConfig.dataType,
         async: false,
         dataType: "json",
         success: function (userData) {
       	  if(userData.code!="000"){
       		  alert(userData.message)
       		  return;
       	  }
       	  if(userData.resp.success!=true){
       		  alert(userData.resp.message)
       		  return;
       	  }
       	  initSelectDataList=userData.resp.data
       	  console.log(initSelectDataList);
        // 1 属性名下拉菜单 option
       	initQueryNameList="";
       	  for(var i=0;i<initSelectDataList.length;i++){
       		  initQueryNameList+="<option  value='"+initSelectDataList[i].english+"'>"+initSelectDataList[i].chinese+"</option>"
       	  }
       	// 2 第一个属性的操作符下拉菜单 option
       	initQueryCriteriaList="";
       	  for(var i=0;i<initSelectDataList[0].list.length;i++){
       		  initQueryCriteriaList+="<option value='"+initSelectDataList[0].list[i].code+"'>"+initSelectDataList[0].list[i].value+"</option>"
       	  }
       	//预留多选框参数初始化
       	  //
       	  //
       	  //条件3输入框
       	  // 3 第一个属性对应的输入框（日期、数字、文体）input
		  if(initSelectDataList[0].style=="date"){//时间格式
              if (globalConfig.dataType == 2){
                  initQueryValue = "<input type='datetime-local' step='01' class='inp-text'>";
              }else {
                  initQueryValue = "<input type='text'  class='inp-text'>";

              }
		  }else if(initSelectDataList[0].style=="number"){//数字格式
			  initQueryValue="<input type='number' class='inp-text'>";
		  }else if(initSelectDataList[0].style=="term"){//字符串格式
			  initQueryValue="<input type='text' class='inp-text'>";
		  }else{//多选

		  }

		//and初始化
		  strBigGroup = `<div class="query-info">
		        <div class="add-new-box">
		          <div class="query-list"><span class="circleLetter query-item-name">A1</span>
		            <div class="inp inp1">
		                <select class="demo-1">`+initQueryNameList+`
		                </select>
		              </div>
		              <div class="inp inp2">
		                <select class="demo-1">`+initQueryCriteriaList+`
		                </select>
		              </div>
		              <div class="inp inp3">`+initQueryValue+`
		              </div>
		              <p class="remove-query-info">
		                  <span></span>
		              </p>
		          </div>
		        </div>
		        <div class="add-button"><br><img class="fa fa-plus-square andOrBtn" src="${staticRoot}/img/orBtn.png"></div>
		      </div><br>`
		   //or下拉框初始化
		   strSmallGroupInit = `<div class="query-list"><span class="circleLetter query-item-name">A1</span>	
		            <div class="inp inp1">
		                <select class="demo-1">`+initQueryNameList+`
		                </select>
		              </div>
		              <div class="inp inp2">
		                <select class="demo-1">`+initQueryCriteriaList+`
		                </select>
		              </div>
		              <div class="inp inp3">`+initQueryValue+`
		              </div>
		              <p class="remove-query-info"><span></span></p>
		          </div>`
		  
		   //or多选框初始化 未完善
		   strMultiGroup = `<div class="query-list">
		            <div class="inp inp1">
		                <select class="demo-1">`+initQueryNameList+`
		                </select>
		              </div>
		              <div class="inp inp2" style=" text-align:center">
		                <div class="checkboxDiv">男</div><input type="checkbox"><div class="checkboxDiv">女</div><input type="checkbox">
		              </div>
		              <p class="remove-query-info"><span></span></p>
		          </div>`
         }
     });
}

//2 属性选择改变事件
function queryCriteriaChangeList(){	
// 	QueryCriteriaList
	$(document).on("change",".inp1 select",function(){
		var $this=$(this);
		QueryCriteriaList="";
		$this.parent().parent().next().next().find("input").val("");
		//遍历完整的数组数据
		for (var i = 0; i < initSelectDataList.length; i++) {
			//获取查询符号列
			if($this.val() == initSelectDataList[i].english){
                var relationId = initSelectDataList[i].id;
                queryRelationDown(relationId);
				var node;
				if(initSelectDataList[i].style!="muilti"){//校验是否为多选
					//构建当前选中的属性的操作符下拉列表
                    for(var j=0;j<initSelectDataList[i].list.length;j++){
                        QueryCriteriaList+="<option value='"+initSelectDataList[i].list[j].code+"'>"+initSelectDataList[i].list[j].value+"</option>"
                    }
                    QueryCriteriaList="<select class='demo-1'>"+QueryCriteriaList+"</select>";
				}else{
                    //多选，暂未开发完全
                    for(var j=0;j<initSelectDataList[i].list.length;j++){
                        QueryCriteriaList+=`<div class="checkboxDiv">initSelectDataList[i].list[j]</div><input type="checkbox"  name="" value="`+initSelectDataList[i].list[j]+`">`;
                    }
				}
				//如果存在则移除，不存在，也不会报错
				$this.parent().parent().next().next().find("span").remove();
				$this.parent().parent().next().next().find(".dateno2").remove();
                if(relationDownData.length > 0 ){
                    initQueryValue = "";
                    initQueryValue = "<select class ='selectId'></select>"
                    var value = null;
                    for (var j = 0; j <relationDownData.length ; j++) {
                        value+="<option value='"+relationDownData[j].option+"'>"+relationDownData[j].option+"</option>"
                    }
                    $this.parent().parent().next().next().html(initQueryValue);//inp3
                    $this.parent().parent().next().next().find("select").html(value);
                }else{
                        if(initSelectDataList[i].style=="date"){//时间格式
                            if (globalConfig.dataType==1){
                                initQueryValue = "<input type='date'  class='inp-text'>";
                                $this.parent().parent().next().next().find("input").prop("type","date");//inp3
                            }else {
                                initQueryValue = "<input type='datetime-local' step='01' class='inp-text'>";
                                $this.parent().parent().next().next().find("input").prop("type","datetime-local");
                                $this.parent().parent().next().next().find("input").prop("step","01");
                            }
                        }else if(initSelectDataList[i].style=="number" || initSelectDataList[i].option == "number"){//数字格式
                            initQueryValue="<input type='number' class='inp-text'>";
                            $this.parent().parent().next().next().find("input").prop("type","number");//inp3
                        }else if(initSelectDataList[i].style=="term"){//字符串格式
                            initQueryValue="<input type='text' class='inp-text'>";
                            $this.parent().parent().next().next().find("input").prop("type","text");//inp3
                        }else{//多选
                            $this.parent().parent().next().next().remove();
                        }
                    node=$this.parent().parent().next().next();//inp2
                    node.html(initQueryValue);
                    node.find(".demo-1").selectMania({
                        size: 'small',
                        // themes: ['darkblue'],
                        placeholder: 'Please select me!',
                        removable: true,
                        search: true,
                    });
                }
                node=$this.parent().parent().next();//inp2
                node.html(QueryCriteriaList);
                node.find(".demo-1").selectMania({
                    size: 'small',
                    // themes: ['darkblue'],
                    placeholder: 'Please select me!',
                    removable: true,
                    search: true,
                });
                return;
			}
		}
	})
}
</script>
<script>
  $().ready(function(){
	  // 1 名单类型列表生成
	  rosterTypeSelectCreate();
	  // 2 绑定属性选择改变事件
	  queryCriteriaChangeList();

      if (globalConfig.channel!="NO_CHANNEL"){
          if (globalConfig.channel=='WK'){
              $('#wkChannel').attr("checked",true);
              $('#qbChannel').attr("checked",false);
          }else {
              $('#wkChannel').attr("checked",false);
              $('#qbChannel').attr("checked",true);
          }
      }

	  // 3 操作符改变事件，操作符改变时，类型是不会变的
	  $(document).on("change",".inp2 select",function(){
			 var $this=$(this);
			 if($this.val() == "between"){
			 	$this.parent().parent().next().html("<input type='date' class='inp-text dateno1'>" + "<span> and </span>" + "<input type='date' class='inp-text dateno2'>");
			 }else{
				 $this.parent().parent().next().find("span").remove();
				 $this.parent().parent().next().find(".dateno2").remove();
			 }
			 if ($this.val()=="isnull" || $this.val()=="notnull"){
			     $this.parent().parent().parent().find('.inp3').hide();
			     $this.parent().parent().parent().find('.inp3 input').val(null);
             }else {
                 $this.parent().parent().parent().find('.inp3').show();
             }
	  });





		  
	  
	  // 3 绑定事件：返回上一页面
	  $("#returnBack").on("click",function(){
		  location.href="${ctx}/ruleConfigIndex";
	  })
	  //初始化数据
	  initdata();
      selectConditionList();
      getRuleList();
      if(!isEmpty(channel)){
          $("[name=channelCode]").eq(0).find("input").removeAttr("checked");
          var checkRadioLength=$(".checkSelect-wrap .checkSelect").length;
          for(var n=0;n<checkRadioLength;n++){
              var tt=$(".checkSelect-wrap .checkSelect").eq(n).find("input").val();
              if(tt==channel){
                  $(".checkSelect-wrap .checkSelect").eq(n).find("input").attr("checked","checked");
              }
          }
      }

	 //渠道改变以后重新初始化
	 $(document).on("change","[name=channelCode]",function(){
		 $(".query-info").each(function(){
			 $(this).next().remove();
			 $(this).remove();
		 })
		 initdata();
	 })
	 
  $('.query-wrap').append(strBigGroup)
  if(selectCreateGroupList=="" && getRulesList ==""){
      $('.demo-1').selectMania({
          size: 'small',
          // themes: ['darkblue'],
          placeholder: 'Please select me!',
          removable: true,
          search: true,
      });
  }
  // 小组件 添加 query-wrap
  $(".query-wrap").on("click"," .query-info .add-button",function(){
    $(this).parent().find('.add-new-box').append(strSmallGroupInit)
    $('.demo-1').selectMania({
      size: 'small', 
      themes: ['darkblue'], 
      placeholder: 'Please select me!',
      removable: true,
      search: true,
    });
  });
  // -
  $(".query-wrap").on("click"," .query-info .add-new-box .remove-query-info",function(){
	  let $parent = $(this).parent()
	  let $parents = $parent.parent()
      if ($parents.children().length >= 2) {
          $parent.remove()
      } else {
          $parents.parent().next().remove();
          $parents.parent().remove();
      }
    
  });
  // 添加 wrap 分组的
  $('.add-query-info-button').on('click',function(){
    $('.query-wrap').append(strBigGroup)
    $('.demo-1').selectMania({
        size: 'small', 
        themes: ['darkblue'], 
        placeholder: 'Please select me!',
        removable: true,
        search: true,
      });
  })
  //查询符合条件的用户数量
  $("#findUserNum").on("click",function(){
	  for (var i = 0; i < $(".query-wrap .demo-1").length; i++) {
		  var $t=$(".query-wrap .demo-1").eq(i);
		  if($t.val()==""||$t.val()==null||$t.val()=="null"){
			  alert("参数为空")
			  return;
		  }
	  }
	   var url = globalConfig.basePath + "/ruleConfigAddDetail/queryAddCount";
		  var data = "channelCode="+$("[name=channelCode]:checked").val();
		  data += "&createUser="+globalConfig.userName;
		  data += "&rosterName="+$("[name=rosterName]").val();
		  data += "&dataType="+globalConfig.dataType;
		  data += "&rosterType="+$("[name=rosterType]").val();
		  var queryInfo = $(".query-info");
		  for (var i = 0; i < queryInfo.length; i++) {
			  var queryList = queryInfo.eq(i).find(".query-list");
			  for (var j = 0; j < queryList.length; j++) {
				  data+="&conditionGroup["+i+"]["+j+"].queryName="+queryList.eq(j).find(".inp1 select").val();
				  //判断是否存在多选
				  if(queryList.eq(j).find("[type=checkbox]").length>0){
					  var checkboxList = queryList.eq(j).find("[type=checkbox]");
					  for (var z = 0; z < checkboxList.length; z++) {
					  	data += "&conditionGroup["+i+"]["+j+"].queryFields["+z+"]="+checkboxList.eq(z).val();
					  }
				  }else{
				  	data += "&conditionGroup["+i+"]["+j+"].queryCriteria="+queryList.eq(j).find(".inp2 select").val();
				  }
                  //特殊处理between,使用逗号分割
                  if(queryList.eq(j).find(".inp2 select").val() == "between"){
                      var startTime = queryList.eq(j).find(".dateno1").eq(0).val();//between对应的开始日期
                      var endTime = queryList.eq(j).find(".dateno2").eq(0).val();//between对应的结束日期
                      data += "&conditionGroup["+i+"]["+j+"].queryValue="+startTime + "," + endTime;
                  }else if(queryList.eq(j).find(".inp3 input").val() != null){
                      var dateValue = "&conditionGroup["+i+"]["+j+"].queryValue="+queryList.eq(j).find(".inp3 input").val();
                      data += dateValue.replace("T"," ");
                  }else{
                      var options = queryList.eq(j).find(".selectId").val();
                      var dateValue = "&conditionGroup["+i+"]["+j+"].queryValue="+ options;
                      data += dateValue;
                  }
			  }
		  }
		  $.post(url,data,function(reData){
			  if(reData.code=="000"){
				  $("#userNum").html(reData.resp.data)
			  }else{
				  alert(reData.message)
				  $("#userNum").html(0)
			  }
		  },"json") 
  })
  $(".reset").on("click",function(){
	  location.reload();
  })
  //新增分组
  $("#saveData").on("click",function(){
	  for (var i = 0; i < $(".query-wrap .demo-1").length; i++) {
		  var $t=$(".query-wrap .demo-1").eq(i);
		  if($t.val()==""||$t.val()==null||$t.val()=="null"){
			  alert("参数为空")
			  return;
		  }
	  }


      for (var c = 0;c < $('.query-wrap .inp2').length;c++){
          var value = $('.query-wrap .inp2').eq(c).find('.demo-1').val();

              if ($(".query-wrap .inp-text").eq(c).val()==""){
                  if (value=='notnull' || value == 'isnull'){
                  break;
                 }else {
                  alert("查询条件不能为空!");
                  return;
                 }
             }
      }


	  var url = globalConfig.basePath + "/ruleConfigAddDetail/add";
	  var data = "channelCode="+$("[name=channelCode]:checked").val();
	  data += "&createUser="+globalConfig.userName;
	  data += "&dataType="+globalConfig.dataType;queryInfo
	  console.log("数据类型",globalConfig.dataType);
	  data += "&rosterName="+$("[name=rosterName]").val();
	  data += "&rosterType="+$("[name=rosterType]").val();
	  var queryInfo = $(".query-info");
	  for (var i = 0; i < queryInfo.length; i++) {
		  var queryList = queryInfo.eq(i).find(".query-list");
		  for (var j = 0; j < queryList.length; j++) {
			  data+="&conditionGroup["+i+"]["+j+"].queryName="+queryList.eq(j).find(".inp1 select").val();
			  //判断是否存在多选
			  if(queryList.eq(j).find("[type=checkbox]").length>0){
				  var checkboxList = queryList.eq(j).find("[type=checkbox]");
				  for (var z = 0; z < checkboxList.length; z++) {
				  	data += "&conditionGroup["+i+"]["+j+"].queryFields["+z+"]="+checkboxList.eq(z).val();
				  }
			  }else{
			  	data += "&conditionGroup["+i+"]["+j+"].queryCriteria="+queryList.eq(j).find(".inp2 select").val();
			  }

			  //特殊处理between,使用逗号分割
			  if(queryList.eq(j).find(".inp2 select").val() == "between"){
				  var startTime = queryList.eq(j).find(".dateno1").eq(0).val();//between对应的开始日期
				  var endTime = queryList.eq(j).find(".dateno2").eq(0).val();//between对应的结束日期

				  data += "&conditionGroup["+i+"]["+j+"].queryValue="+startTime + "," + endTime;
			  }
			  else{
                  if(queryList.eq(j).find(".inp3 input").val() != null){
                      var selectValue = "&conditionGroup["+i+"]["+j+"].queryValue="+queryList.eq(j).find(".inp3 input").val();
                      data += selectValue.replace("T"," ");
                  }else{
                      var options = queryList.eq(j).find(".selectId").val();
                      var selectValue = "&conditionGroup["+i+"]["+j+"].queryValue="+options;
                      data += selectValue;
                  }
			  }
		  }
	  }
	 $.post(url,data,function(reData){
		  alert(reData.message);
		  if(reData.code=="000"){

              window.location.href=(globalConfig.basePath+"/ruleConfigIndex?QD="+$("[name=channelCode]:checked").val());
          }
	  },"json") 
  })
  
  	$('.query-wrap').on('click',".remove-query-info, .add-button",function(){
		conditionDesc();
	});
	  
  	$('.add-query-info-button').on('click',null,function(){
		conditionDesc();
	});

	var groupPrexArray = new Array();
	for(var i=0;i<26;i++){
		groupPrexArray[i] = String.fromCharCode(65+i);
	}

	function conditionDesc(){
		var andGroupLength = $('.query-info').length;
		var str = "";
		for(var i=0; i<andGroupLength; i++){
			var itemLength = $('.query-info').eq(i).find('.query-list').length;
				str += '(';
			for(var j=0; j<itemLength; j++){
				str += ( groupPrexArray[i] + (j+1) + ' or ');
				$('.query-info').eq(i).find('.query-list').eq(j).find('.query-item-name').html(groupPrexArray[i] + (j+1));
			}
			str = str.substr(0,str.length-4);
				str += ')';
			str += " and ";
		}
		str = str.substr(0,str.length-5);
		$('#showConditon').html(str);
	}
	conditionDesc();


      //用户画像优化
     if (getRulesList!="") {

         $('.query-wrap').html(null);
         $('.query-info').html(null);
         for (var i = 0; i < getRulesList.conditionGroup.length; i++) {
             $('.query-wrap').append(strBigGroup);
             conditionDesc();
             for (var t = 1; t < getRulesList.conditionGroup[i].length; t++) {
                 $('.query-info').eq(i).find('.add-new-box').append(strSmallGroupInit)
                 conditionDesc();
             }


         }

             //获取select框下的option长度
                 if(getRulesList!=""){

                     for(var t=0;t<getRulesList.conditionGroup[t].length;t++){
                         var optionListLength=$('.query-info ').eq(t).find('.inp1 .demo-1 option').length;
                         for (var r = 0;r < getRulesList.conditionGroup[t].length;r++){
                             for(var j=0;j<optionListLength;j++){
                                 //取得每个option标签的值
                                 var firstOptionValue=$('.query-info').eq(t).find('.inp1 .demo-1 option').eq(j).val();
                         if (getRulesList.conditionGroup[t][r].queryName == firstOptionValue) {
                             $('.query-info').eq(t).find('.query-list').eq(r).find('.inp1 .demo-1 option[value=' + firstOptionValue + ']').attr("selected", "seelcted");
                             }
                         }
                     }
                 }
         };

         // //设置第二个条件
         if (getRulesList!=""){
             for(var i=0;i<getRulesList.conditionGroup.length;i++){
               var  secondSelectListLength = null;
                 for (var t =0;t < getRulesList.conditionGroup[i].length;t++){
                     for (var c=0;c < initSelectDataList.length;c++){
                         var html = "";
                         if (initSelectDataList[c].english == getRulesList.conditionGroup[i][t].queryName){
                             secondSelectListLength = initSelectDataList[c].list.length;
                             for (var y = 0;y < initSelectDataList[c].list.length;y++){

                                     html+="<option value='"+initSelectDataList[c].list[y].code+"'>"+initSelectDataList[c].list[y].value+"</option>"

                             }
                             $('.query-info').eq(i).find('.query-list').eq(t).find('.inp2 .demo-1').html(html);
                         }
                     }
                     for (var j = 0; j < secondSelectListLength; j++) {
                         //取得每个option标签的值
                         var optionValue = $('.query-info').eq(i).find('.query-list').eq(t).find('.inp2 .demo-1 option').eq(j).val();
                         if (getRulesList.conditionGroup[i][t].queryCriteria == optionValue) {
                             $('.query-info').eq(i).find('.query-list').eq(t).find('.inp2 .demo-1 option[value=' + optionValue + ']').attr("selected", "selected");
                         }
                     }


             }
         }
         }
         //设置第三条件参数
         for(var i=0;i<getRulesList.conditionGroup.length;i++) {
             if (getRulesList != "") {
                 for (var c = 0; c < getRulesList.conditionGroup[i].length; c++) {
                     //获取第三个条件的值
                     var queryOptionValue = getRulesList.conditionGroup[i][c].queryValue;
                     var optionValueType = getRulesList.conditionGroup[i][c].option;

                     //重新设置输入框类型
                     if (optionValueType == "number") {
                         $('.query-info').eq(i).find('.query-list').eq(c).find('.inp3 input').attr("type", "number");
                     } else if (optionValueType == "date") {
                         if (globalConfig.dataType==1){
                             $('.query-info').eq(i).find('.query-list').eq(c).find('.inp3 input').attr("type", "date");
                         }else {
                             $('.query-info').eq(i).find('.query-list').eq(c).find('.inp3 input').attr("type", "datetime-local");
                             $('.query-info').eq(i).find('.query-list').eq(c).find('.inp3 input').attr("step", "01");
                             console.log("实时画像日期值",queryOptionValue)
                             queryOptionValue=queryOptionValue.replace(" ","T");
                         }

                     } else {
                         $('.query-info').eq(i).find('.query-list').eq(c).find('.inp3 input').attr("type", "text");
                     }
                     if (!queryOptionValue){
                         $('.query-info').eq(i).find('.query-list').eq(c).find('.inp3').hide();
                         continue;
                     }

                     $('.query-info').eq(i).find('.query-list').eq(c).find('.inp3 input').val(queryOptionValue);
                 }
             }
         }
         $('.demo-1').selectMania({
             size: 'small',
             // themes: ['darkblue'],
             placeholder: 'Please select me!',
             removable: true,
             search: true,
         });
         // };
     }

    //三期--start--
    if(selectCreateGroupList!=""){

        for(var i=1;i<selectCreateGroupList.length;i++){
            $('.query-wrap').append(strBigGroup)
            conditionDesc();
        }
        var sumGroupLength = $('.query-info').length;
        for(var i=0;i<sumGroupLength;i++){
            //获取select框下的option长度
            var optionListLength=$('.query-info ').eq(i).find('.inp1 .demo-1 option').length;
            for(var j=0;j<optionListLength;j++){
                //取得每个option标签的值
                var firstOptionValue=$('.query-info').eq(i).find('.inp1 .demo-1 option').eq(j).val();
                if(selectCreateGroupList!=""){
                    for(var t=0;t<selectCreateGroupList.length;t++){
                        if(selectCreateGroupList[t].queryName==firstOptionValue){
                            $('.query-info').eq(i).find('.inp1 .demo-1 option[value='+firstOptionValue+']').attr("selected","selected");
                        }
                    }
                }
            }
        };

        //设置第二个条件
        if(selectCreateGroupList != ""){
            for(var i=0;i<selectCreateGroupList.length;i++){
                //获取每个select框下的所有option长度
                var secondSelectListLength = $('.query-info ').eq(i).find('.inp2 .demo-1 option').length;
                for (var j = 0; j < secondSelectListLength; j++) {
                    //取得每个option标签的值
                    var optionValue = $('.query-info').eq(i).find('.inp2 .demo-1 option').eq(j).val();
                    var optionTextValue = $('.query-info').eq(i).find('.inp2 .demo-1 option').eq(j).text();
                    if (selectCreateGroupList[i].queryCriteria == optionTextValue) {
                        $('.query-info').eq(i).find('.inp2 .demo-1 option[value=' + optionValue + ']').attr("selected", "selected");
                    }
                }
            }
        };

        //设置第三条件参数
        for(var i=0;i<sumGroupLength;i++){
            if(selectCreateGroupList!=""){
                //获取第三个条件的值
                var queryOptionValue=selectCreateGroupList[i].queryValue;
                var optionValueType=selectCreateGroupList[i].option;
                //重新设置输入框类型
                if(optionValueType=="number"){
                    $('.query-info').eq(i).find('.inp3 input').attr("type","number");
                }else if(optionValueType=="date"){
                    $('.query-info').eq(i).find('.inp3 input').attr("type","date");
                }else{
                    $('.query-info').eq(i).find('.inp3 input').attr("type","text");
                }
                $('.query-info').eq(i).find('.inp3 input').val(queryOptionValue);
            }
        };
        $('.demo-1').selectMania({
            size: 'small',
            // themes: ['darkblue'],
            placeholder: 'Please select me!',
            removable: true,
            search: true,
        });
    }

    //三期--end--






  });
</script>
</body>
</html>
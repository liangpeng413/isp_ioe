<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>智能服务管理</title>
    <link href="${cssRoot}/bootstrap.min.css" rel="stylesheet">
    <link href="${staticRoot}/font-awesome/css/font-awesome.css" rel="stylesheet">

    <!-- FooTable -->
    <link href="${cssRoot}/plugins/footable/footable.core.css" rel="stylesheet">

    <link href="${cssRoot}/animate.css" rel="stylesheet">
    <link href="${cssRoot}/style.css?rand=${random}" rel="stylesheet">
    <link href="${cssRoot}/styleT.css?rand=${random}" rel="stylesheet">
    <link href="${staticRoot}/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <style type="text/css">
        .boxb-a > div {
            margin: 20px 0;
        }

        #addPage .small-boxb div {
            float: none
        }

        #addPage .small-boxb div label {
            vertical-align: top;
            margin-right: 10px;
        }

        #add-task-rule > div {
            margin: 10px 0;
        }

        .addShowType div {
            display: flex;
            margin-left: 0;
            align-items: center;
        }

        .addShowType div select {
            margin-top: 10px;
        }

        .addShowType div span {
            margin: 5px 0 0 15px;
        }

        .addShowType div input {
            margin-top: 7px;
        }

        .addShowType div p {
            margin: 0;
        }
        .bottom-pageb i{
            cursor:pointer;
        }
    </style>
    <script>
        var globalConfig = {
            basePath: "${ctx}",
            staticRoot: "${staticRoot}",
            loginName: "${Session.sessionUser.loginName}",
            userName: "${Session.sessionUser.name}",
            returnChannel: "${Session.returnChannel}",
        };

        function swalMsg(msg) {
            swal({
                title: "",
                text: msg,
                confirmButtonColor: "#1ab394",
                confirmButtonText: "确定"
            });
        }

    </script>
</head>
<body>
<div id="wrapper">
    <div class="header-box">
        <#include "/common/top.html" encoding="UTF-8" />
    </div>
    <nav class="navbar-default navbar-static-side nav-boxa" role="navigation" id="HeadTitle">
        <div class="sidebar-collapse"  style="height: 675px;overflow-y: scroll;">
            <#include "/common/left.html" encoding="UTF-8" />
        </div>
    </nav>
</div>
<div class="content-box">
    <div class="small-content">
        <!-- 第二部分 -->
        <div class="small-boxb col-md-12">
            <div class="boxb-a">
                <p style="margin-top:20px;">渠道：
                    <select class="chosen-select" style="width:160px;" tabindex="2" id="channel">
                        <option value="WK">悟空理财</option>
                        <option value="QB">玖富钱包</option>
                    </select>
                </p>
            </div>
            <div class="boxb-b">
                <p>服务类型：
                    <select class="chosen-select" style="width:160px;" tabindex="2" id="service">
                        <option value="">全部</option>
                        <option value="WK">用户支付</option>
                        <option value="QB">用户还款</option>
                    </select>
                </p>
            </div>
            <div class="boxb-c">
                <p style="margin-top:20px;">用户行为：
                    <select class="chosen-select" style="width:160px;" tabindex="2" id="user">
                        <option value="">全部</option>
                        <option value="WK">支付成功</option>
                        <option value="QB">支付失败</option>
                    </select>
                </p>
            </div>
            <div class="boxb-a">
                <p style="margin-top:20px;">
                    <span class="btn btn-success btn-rounded btn-blueW btn-blueWa" id="seek">
                    <i class="fa fa-search"></i><span>搜索</span></span>
                    <span class="btn btn-success btn-rounded btn-blueW btn-blueWb" id="reset">
                    <i class="fa fa-refresh"></i><span>重置</span></span>
                </p>
            </div>
        </div>
        <!-- 第二部分 -->
        <!-- 第三部分 -->
        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins" style="margin-top:10px;">
                    <div class="ibox-content">
                        <table class="footable table table-stripped" data-page-size="8" data-filter=#filter>
                            <thead>
                            <tr>
                                <th>服务ID</th>
                                <th>渠道</th>
                                <th>服务类型</th>
                                <th>用户行为</th>
                                <th>生效策略数</th>
                                <th>总策略数</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>
                                    <a href="javascript:void(0)" class="look-start magService"></a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="bottom-page">
                            <div class="bottom-pageb">
                                <i class="fa fa-step-backward"></i>
                                <i class="fa fa-caret-left"></i>
                                <p>第<span class="pageN"></span>共<span class="lastPage"></span>页</p>
                                <i class="fa fa-caret-right" style="margin-left:8px;"></i>
                                <i class="fa fa-step-forward"></i>
                                <i class="fa fa-refresh"></i>
                                <p>共<span class="totalRowSize"></span>条记录
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="${jsRoot}/jquery-2.1.1.js"></script>
<script src="${jsRoot}/bootstrap.min.js"></script>
<script src="${jsRoot}/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="${jsRoot}/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="${jsRoot}/plugins/jeditable/jquery.jeditable.js"></script>

<script src="${jsRoot}/jquery-2.1.1.js"></script>
<script src="${jsRoot}/plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="${jsRoot}/angular/angular.min.js"></script>
<script type="text/javascript" src="${staticRoot}/js/plugins/sweetalert/sweetalert.min.js"></script>
<script src="${jsRoot}/plugins/laydate/laydate.js"></script>
<script src="${jsRoot}/bootstrap.min.js"></script>

<script src="${jsRoot}/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="${jsRoot}/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="${jsRoot}/plugins/jeditable/jquery.jeditable.js"></script>


<!-- Custom and plugin javascript -->
<script src="${jsRoot}/inspinia.js"></script>
<script src="${jsRoot}/plugins/pace/pace.min.js"></script>
<script src="${jsRoot}/plugins/fileUpload/jquery.fileupload.js"></script>
<script src="${jsRoot}/plugins/fileUpload/jquery.iframe-transport.js"></script>
<script src="${jsRoot}/plugins/fileUpload/jquery.ui.widget.js"></script>
<script src="${jsRoot}/plugins/fileUpload/jquery.fileupload-process.js"></script>
<script src="${jsRoot}/plugins/fileUpload/jquery.fileupload-validate.js"></script>

<!-- Data Tables -->
<script src="${jsRoot}/plugins/dataTables/jquery.dataTables.js"></script>
<script src="${jsRoot}/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="${jsRoot}/plugins/dataTables/dataTables.responsive.js"></script>
<script src="${jsRoot}/plugins/dataTables/dataTables.tableTools.min.js"></script>
<script src="${jsRoot}/plugins/laydate/laydate.js"></script>
<script src="${jsRoot}/DateUtil.js"></script>
<!-- Custom and plugin javascript -->
<script src="${jsRoot}/inspinia.js"></script>
<script src="${jsRoot}/plugins/pace/pace.min.js"></script>
<script type="text/javascript" src="${jsRoot}/angular/angular.min.js"></script>
<!--  日期控件  -->
<script src="${jsRoot}/plugins/datapicker/bootstrap-datepicker.js"></script>
<script src="${jsRoot}/plugins/datapicker/bootstrap-datepicker.zh-CN.min.js"></script>
<!-- 提示弹窗 -->
<script type="text/javascript" src="${staticRoot}/js/plugins/sweetalert/sweetalert.min.js"></script>
<!-- <script type="text/javascript" src="${jsRoot}/biz/baseFoot.js?rand=${random}"></script> -->
<!-- <script type="text/javascript" src="${jsRoot}/oms/smartManangerQuery.js?rand=${random}"></script> -->
<!-- <script type="text/javascript" src="${jsRoot}/oms/smartManangerDetail.js?rand=${random}"></script> -->

<script>

    var navHight = $('.navbar-static-side').height()
    $('.navbar-static-side').css('height', navHight - 60)
    $('.content-box').css('height', navHight - 60)

    $(document).ready(function () {
        function onMenuClick() {
            $("#strategyIndexs li").removeClass("active");
            $("#smartService").addClass("active");
            $("#strategyIndexs").addClass("collapse in");
            $("#strategyIndex_menus").addClass("active");
        }
        onMenuClick();
    });
    //一页显示行数
    var pageSize=10;
    //分页操作
    //分页操作
    function paging(){
        //上一页
        $(".fa-caret-left").on("click",function(){
            //当前页
            var  currentPage=parseInt($(".pageN").html());
            //最大 页码
            var  pageCount=parseInt($(".lastPage").html());
            if(currentPage==1){
                return;
            }
            currentPage=currentPage-1;
            //生成列表
            $.post("${ctx}/operation/query/levelone", "currentPage="+currentPage+"&pageSize="+pageSize, function (data) {
                pageContextLevel1(data);
            }, "json");
        });
        //下一页
        $(".fa-caret-right").on("click",function(){
            //当前页
            var  currentPage=parseInt($(".pageN").html());
            //最大 页码
            var  pageCount=parseInt($(".lastPage").html());
            if(currentPage==pageCount){
                return;
            }
            currentPage=currentPage+1;
            //生成列表
            $.post("${ctx}/operation/query/levelone", "currentPage="+currentPage+"&pageSize="+pageSize, function (data) {
                pageContextLevel1(data);
            }, "json");
        });
        //第一页
        $(".fa-step-backward").on("click",function(){
            //当前页
            var  currentPage=parseInt($(".pageN").html());
            //最大 页码
            var  pageCount=parseInt($(".lastPage").html());
            if(currentPage==1){
                return;
            }
            currentPage=1;
            //生成列表
            $.post("${ctx}/operation/query/levelone", "currentPage="+currentPage+"&pageSize="+pageSize, function (data) {
                pageContextLevel1(data);
            }, "json");
        });
        //最后一页
        $(".fa-step-forward").on("click",function(){
            //当前页
            var  currentPage=parseInt($(".pageN").html());
            //最大 页码
            var  pageCount=parseInt($(".lastPage").html());
            if(currentPage==pageCount){
                return;
            }
            currentPage=pageCount;
            //生成列表
            $.post("${ctx}/operation/query/levelone", "currentPage="+currentPage+"&pageSize="+pageSize, function (data) {
                pageContextLevel1(data);
            }, "json");
        });
        //刷新
        $(".fa-refresh").on("click",function(){
            //当前页
            var  currentPage=parseInt($(".pageN").html());
            //最大 页码
            var  pageCount=parseInt($(".lastPage").html());
            //生成列表
            $.post("${ctx}/operation/query/levelone", "currentPage="+currentPage+"&pageSize="+pageSize, function (data) {
                pageContextLevel1(data);
            }, "json");
        });
    }
    // 请求一级列表接口后生成页面方法
    function pageContextLevel1(data) {
        if (data.code != "000") {
            alert(data.message);
            return;
        }
        var resp = data.resp;
        $(".lastPage").html(resp.pageCount);
        $(".pageN").html(resp.currentPage);
        $(".totalRowSize").html(resp.totalRowSize);
        var res = resp.result;
        console.log(res);
        var str = "";
        $("tbody").html(str);
        for (var i = 0; i < res.length; i++) {
            str += "<tr>" +
                "<td style='display: none;'>" + res[i].userTag + "</td>" +
                "<td style='display: none;'>" + res[i].touchStrategy + "</td>" +
                "<td style='display: none;'>" + res[i].nodeCode + "</td>" +
                "<td>" + res[i].id + "</span></td>" +
                "<td>" + res[i].channelName + "<input type='hidden' id='channelCode' value='" + res[i].channelCode + "'></td>" +
                "<td>" + res[i].serviceName + "<input type='hidden' id='serviceCode' value='" + res[i].serviceCode + "'></td>" +
                "<td>" + res[i].userActionName + "<input type='hidden' id='userActionCode' value='" + res[i].userActionCode + "'></td>" +
                "<td>" + res[i].vaildStrategy + "</td>" +
                "<td>" + res[i].totalStrategy + "</td>" +
                "<td><a href='javascript:void(0)' class='look-start magService'>管理服务</a></td>" +
                "</tr>"
        }
        $("tbody").html(str);
        $(document).on("click",".magService",function(){
            var $this = $(this);
            var parents = $this.parent().prevAll();
            var userTag  = parents.eq(8).text();
            var touchStrategy = parents.eq(7).text();
            var nodeCode = parents.eq(6).text();
            var fId = parents.eq(5).text();
            var channel = parents.eq(4).text();
            var channelCode = parents.eq(4).find("input").val();
            var fType = parents.eq(3).text();
            var serviceCode = parents.eq(3).find("input").val();
            var userWay = parents.eq(2).text();
            var userActionCode = parents.eq(2).find("input").val();
            // var touchStrategy
            var param = "fId=" + fId + "&channel=" + channel +"&channelCode="+channelCode+
                "&fType=" + fType+"&serviceCode="+serviceCode + "&userWay=" + userWay+"&userActionCode="+userActionCode+"&touchStrategy="
                +touchStrategy+"&nodeCode="+nodeCode+"&userTag="+userTag;
            $.post("${ctx}/strategyIndex/strategyListLevel2",param, function (data) {
                if (data.code != "000") {
                    alert(data.message);
                    return;
                }
                window.location.href = "${ctx}/" + data.data;
            }, "json")
        })
    }
    function serviceSelectCreate(){
        $.post(globalConfig.basePath + "/operation/init/byKey","type=12&code="+$("#channel").val(),function(data){
            var strService="";
            if(data.resp){
                for (var i = 0; i < data.resp.length; i++) {
                    strService+="<option value='"+data.resp[i].key+"'>"+data.resp[i].value+"</option>"
                }
            }
            $("#service").html("<option value=''>全部</option>"+strService)
            userSelectCreate();
        },"json")
    }
    function userSelectCreate(){
        $.post(globalConfig.basePath  + "/operation/init/byKey","type=13&code="+$("#service").val(),function(res){
            var strUser="";
            if(res.resp){
                for (var i = 0; i < res.resp.length; i++) {
                    strUser+="<option value='"+res.resp[i].key+"'>"+res.resp[i].value+"</option>"
                }
            }
            $("#user").html("<option value=''>全部</option>"+strUser)
        },"json")
    }
    $(function () {

        if(globalConfig.returnChannel!=''){
            $('#channel').val(globalConfig.returnChannel);
            $("#channel").trigger("change");
            globalConfig.returnChannel = null;
            $.ajax({
                type: "get",
                url: globalConfig.basePath + "/strategyIndex/cleanReturnChannel",
                data: "type=8" ,
                async: false,
                dataType: "json",
                success: function (data) {
                    if (data.code != '000') {
                        alert(data.message);
                        return;
                    }
                }
            })
        }

        $(document).on("change","#channel",function(){
            serviceSelectCreate();
        })
        $(document).on("change","#service",function(){
            userSelectCreate();
        })
        paging();
        // 页面初始化
        $.post("${ctx}/operation/query/levelone", "currentPage=1&pageSize="+pageSize+"&channelCode="+$("#channel").val(), function (data) {
            pageContextLevel1(data)
        }, "json");
        /*  $.post("${ctx}/operation/query/levelone", "currentPage=1&pageSize="+pageSize+"&channelCode=QB&serviceCode=QB_MAIN_FLOW&userCode=QB_USER_RECHARGE", function (data) {
             pageContextLevel1(data)
         }, "json"); */

        serviceSelectCreate();
        //搜索功能
        $("#seek").on("click", function () {
            var channelCode = $("#channel").val();
            var serviceCode = $("#service").val();
            var userCode = $("#user").val();
            var param = "channelCode=" + channelCode + "&currentPage=1&pageSize="+pageSize+"&serviceCode=" + serviceCode + "&userCode=" + userCode;
            $.post("${ctx}/operation/query/levelone", param, function (data) {
                pageContextLevel1(data);
            }, "json");
        });
        $("#reset").on("click", function () {
            $("#channel").val("WK");
            $("#service").val("");
            $("#user").val("");
        });
    })


</script>
</body>
</html>
